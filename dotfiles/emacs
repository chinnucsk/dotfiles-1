;; Trailing whitespaces
(setq-default show-trailing-whitespace t)

;; Highlight long lines
(require 'whitespace)
(setq-default whitespace-style '(face trailing lines empty indentation::space))
(setq-default whitespace-line-column 80)
(global-whitespace-mode 1)
(whitespace-mode 1)

;; Menus and scrollbars are for the weak
(menu-bar-mode -1)
(tool-bar-mode -1)
(scroll-bar-mode -1)

;; Show line numbers
(global-linum-mode 1)

;; Darkness will reign
(require 'color-theme)
(load-file "emacs-theme-tangotango.el")
(color-theme-initialize)
(color-theme-tangotango)

;; Highlight the current line in dark gray
(global-hl-line-mode t)
(set-face-background hl-line-face "gray13")

;; Interactively Do Things
(ido-mode 1)
(setq ido-decorations (quote ("\n-> " "" "\n   " "\n   ..." "[" "]" " [No match]" " [Matched]" " [Not readable]" " [Too big]" " [Confirm]")))
(add-hook 'ido-minibuffer-setup-hook #'(lambda() (set (make-local-variable 'truncate-lines) nil)))
(add-hook 'ido-minibuffer-setup-hook #'(lambda() (enlarge-window 10)))

;; Store Backup files in a common place
(setq backup-directory-alist `(("." . "~/.emacs-backups")))

;; Fix indentation for JS Mode
(setq js-indent-level 2)

;; Validate JSON files on the fly
;; Requires jslint. Install it via `npm -g install jslint`
;; Source: http://www.emacswiki.org/emacs/FlymakeJavaScript
(add-to-list 'auto-mode-alist '("\\.json\\'" . js-mode))
(when (load "flymake" t)
  (defun flymake-jslint-init ()
    (let* ((temp-file (flymake-init-create-temp-buffer-copy
                       'flymake-create-temp-inplace))
           (local-file (file-relative-name
                        temp-file
                        (file-name-directory buffer-file-name))))
      (list "jslint" (list "--terse" local-file))))

  (setq flymake-err-line-patterns
        (cons '("^\\(.*\\)(\\([[:digit:]]+\\)):\\(.*\\)$"
                1 2 nil 3)
              flymake-err-line-patterns))

  (add-to-list 'flymake-allowed-file-name-masks
               '("\\.json\\'" flymake-jslint-init))
  )

(add-hook 'js-mode-hook
          (lambda () (flymake-mode t)))

;; Have rebar playing nice with erlang-flymake
(defun mh-simple-get-deps-code-path-dirs ()
  (and (buffer-file-name)
       (let ((default-directory (file-name-directory (buffer-file-name))))
         (file-expand-wildcards "../../*/ebin/"))))

(defun mh-simple-get-deps-include-dirs ()
  (list "../include"))

(setq erlang-flymake-get-code-path-dirs-function 'mh-simple-get-deps-code-path-dirs
      erlang-flymake-get-include-dirs-function 'mh-simple-get-deps-include-dirs)

;; Use this to debug flymake related issues
(defun my-flymake-compile-manually ()
  (interactive)
  (let* ((init-f (flymake-get-init-function buffer-file-name))
         (cmd-and-args (funcall init-f))
         (cmd (nth 0 cmd-and-args))
         (args (nth 1 cmd-and-args))
         (dir (nth 2 cmd-and-args)))
    (let ((default-directory (or dir default-directory)))
      (compile
       (apply 'concat cmd " " (mapcar (lambda (arg) (concat (shell-quote-argument arg) " ")) args))))))

;; Allow emacs to open file as root
;; C-x C-f /sudo::/path/to/file
(require 'tramp)
